# Web 应用的自动更新机制

## 什么是 Web 应用自动更新

Web 应用的自动更新是指在用户访问网站时，能够自动检测并应用最新版本的前端资源（HTML、CSS、JavaScript 等），确保用户始终使用最新功能和修复的版本。

## 与传统应用更新的区别

### 传统桌面/移动应用

- 需要用户手动下载安装包
- 更新过程可能中断使用
- 版本控制相对复杂

### Web 应用

- 服务器端部署即可生效
- 客户端自动获取更新
- 需要处理缓存和兼容性问题

## 实现方式—文件哈希

因为我们打包后，构建工具会自动生成文件指纹，如：

`<script type="module" crossorigin src="/assets/index-BSphUugS.js"></script>`

使用 ajax 请求首页('/')

```javascript
fetch('/')
  .then((res) => res.text())
  .then((res) => console.log(res))
```

分析字符串里面 js 的外部链接，如果变化了则说明服务器中资源更新了。

```javascript
// 用于存储上一次获取的脚本资源链接列表，用于后续比较
let lastSrcs

// 正则表达式，用于匹配HTML中的script标签及其src属性
// 使用命名捕获组(?<src>[^"']+)来提取src属性值
const scriptReg = /\<script.*src=["'](?<src>[^"']+)/gm

/**
 * 获取最新页面中的script链接
 * 通过请求首页HTML内容，解析出所有script标签的src属性
 */
const extractNewScriptSrcs = async () => {
  // 请求首页内容，添加时间戳参数防止浏览器缓存
  const html = await fetch('/?_timestamp=' + Date.now()).then((res) =>
    res.text()
  )

  // 重置正则表达式的lastIndex，确保从头开始匹配
  scriptReg.lastIndex = 0

  let result = []
  let match

  // 循环匹配HTML中的所有script标签，提取src属性
  while ((match = scriptReg.exec(html))) {
    result.push(match.groups.src) // 将匹配到的src属性值添加到结果数组
  }

  return result // 返回所有script资源链接的数组
}

// 检查是否有新的版本更新
const checkUpdate = async () => {
  // 获取当前服务器最新的script资源链接
  const newScripts = await extractNewScriptSrcs()

  // 如果是第一次检查（lastSrcs未初始化），则保存当前脚本列表并返回无更新
  if (!lastSrcs) {
    lastSrcs = newScripts
    return false
  }

  let result = false // 默认无更新

  // 比较脚本数量，如果数量不同则说明有更新
  if (lastSrcs.length !== newScripts.length) {
    result = true
  }

  // 逐个比较脚本链接，如果任一链接不同则说明有更新
  for (let i = 0; i < lastSrcs.length; i++) {
    if (lastSrcs[i] !== newScripts[i]) {
      result = true
      break // 发现不同立即退出循环
    }
  }

  // 更新本地存储的脚本链接列表为最新值
  lastSrcs = newScripts

  return result // 返回是否有更新的结果
}

// 检查更新的时间间隔，单位毫秒（2000ms = 2秒）
const DURATION = 2000

// 自动刷新检查函数，实现定时检查更新的循环机制
const autoRefresh = () => {
  setTimeout(async () => {
    // 检查是否有更新
    const willUpdate = await checkUpdate()

    // 如果检测到更新，则提示用户刷新页面
    if (willUpdate) {
      // 可替换为自定义弹窗或更友好的用户界面
      const result = confirm('是否刷新页面以获取最新内容？')
      if (result) {
        // 用户确认后刷新页面，加载最新资源
        location.reload()
      }
    }

    // 递归调用自身，实现持续的更新检查
    autoRefresh()
  }, DURATION) // 按设定的时间间隔执行
}

// 启动自动更新检查机制
autoRefresh()
```
